#! /bin/bash

# Generate input file from xyz by hy (2025/11/14)
# 書式：orca_xyz2inp XYZ-File TEMPLATE-File "suffix, INPUTファイルの後につける文字（例:-freq）"
# TEMPALTE File: Just header without last structure block

help() {
    echo "
usage: 
    orca_xyz2inp [-h] [-f] [-c <CHRGE>] [-m <MULTIPLICITY>] <XYZ-FILE> <TEMPLATE-File> <SUFFIX>

TEMPALTE File: Just header without last structure block.

h: help
f: force overwrite.
c: charge (default is 0, or from XYZ comment line).
m: multiplicity (default is 1, or from XYZ comment line).
" >&2
}

#初期値
nprocs=1
maxcore=1000
charge_default=0
multiplicity_default=1
force="false"
charge_opt=""
multiplicity_opt=""

# environment variable check
if [[ ! -z $orca_xyz2inp_nprocs ]]; then
  nprocs=$orca_xyz2inp_nprocs
fi
if [[ ! -z $orca_xyz2inp_maxcore ]]; then
  maxcore=$orca_xyz2inp_maxcore
fi

#オプション解析
while getopts hfc:m: OPT
do
  case $OPT in
    # --- 変更箇所 3: 一時変数に格納 ---
    c ) 
        charge_opt="$OPTARG"      
        ;;
    m ) 
        multiplicity_opt="$OPTARG"      
        ;;
    f ) 
        force="true"    
        ;;
    h ) 
        help && exit 1     
        ;;
    * ) 
        help && exit 2     
        ;;
  esac
done
shift $(expr $OPTIND - 1)

xyz_file=$1
template_file=$2
suffix=$3

#書式確認
if [ $# != 3 ]; then
    echo "書式が違います．"
    help
    exit 2
fi

if [ ! -e $template_file ];
then
    echo "Template file was not found."
    echo "Aborted."
    exit 2
fi

if [ ! -e $xyz_file ];
then
    echo "xyz file was not found."
    echo "Aborted."
    exit 2
fi


line2=$(sed -n '2p' $xyz_file)
charge_xyz=$(echo "$line2" | sed -n 's/.*chrg\s*=\s*\([0-9-]\+\).*/\1/p')
multiplicity_xyz=$(echo "$line2" | sed -n 's/.*mult\s*=\s*\([0-9]\+\).*/\1/p')

if [ -n "$charge_opt" ]; then
    charge=$charge_opt
elif [ -n "$charge_xyz" ]; then
    charge=$charge_xyz
else
    charge=$charge_default
fi

if [ -n "$multiplicity_opt" ]; then
    multiplicity=$multiplicity_opt
elif [ -n "$multiplicity_xyz" ]; then
    multiplicity=$multiplicity_xyz
else
    multiplicity=$multiplicity_default
fi


xyzBaseName=`basename $xyz_file`
inputFileName="${xyzBaseName%.xyz}$suffix.inp"
echo "Generating input file from $xyz_file & $template_file (c=$charge, m=$multiplicity) ..." 
if [ ! -e $inputFileName ];
then
    echo "Writing to $inputFileName"
    echo "#Generated by orca_xyz2inp from $xyz_file & $template_file (c=$charge, m=$multiplicity)" > $inputFileName
    echo "%pal nprocs $nprocs end" >> $inputFileName
    echo "%MaxCore $maxcore" >> $inputFileName
    echo "" >> $inputFileName
    cat $template_file >> $inputFileName
    echo "" >> $inputFileName
    echo "* xyz $charge $multiplicity" >> $inputFileName
    echo -n "#" >> $inputFileName
    tail -n +2 $xyz_file >> $inputFileName
    echo "*" >> $inputFileName
elif  [ $force = true ]; then
    echo "Writing to $inputFileName"
    echo "#Generated by orca_xyz2inp from $xyz_file & $template_file (c=$charge, m=$multiplicity)" > $inputFileName
    echo "%pal nprocs $nprocs end" >> $inputFileName
    echo "%MaxCore $maxcore" >> $inputFileName
    echo "" >> $inputFileName
    cat $template_file >> $inputFileName
    echo "" >> $inputFileName
    echo "* xyz $charge $multiplicity" >> $inputFileName
    echo -n "#" >> $inputFileName
    tail -n +2 $xyz_file >> $inputFileName
    echo "*" >> $inputFileName
else
   
    echo "Input File exists! ($inputFileName). Aborted."
    echo "Use -f option to overwrite."
fi
